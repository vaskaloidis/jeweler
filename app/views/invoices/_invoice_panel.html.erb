<%

  if invoice.project.sprint_current == invoice.sprint
    if invoice.open == false
      invoice.open = true
      invoice.save
    end
  end

  # Totals
  hour_total = 0
  price_total = 0
  invoice.invoice_items.each do |task|
    hour_total = hour_total + task.hours
    price_total = price_total + (task.hours * task.rate)
  end

  payment_total = 0
  invoice.payments.each do |payment|
    payment_total = payment_total + payment.amount
  end
%>
<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">
      Sprint <%= sprint %>
    </h4>
    <div style="color:white !important;font-size: 18px;" class="panel-options">
      <% if invoice.open? %>
        <% if invoice.project.sprint_current == invoice.sprint %>
          <div class="label label-success">Current Sprint</div>
        <% else %>
          <div class="label label-success">Sprint Open</div>
        <% end %>
      <% else %>
        <div class="label label-danger">Sprint Closed</div>
      <% end %>

      <% if !invoice.payment_due? %>
        <div style="display:none;margin-right:10px" id="request_payment_2_sprint_<%= invoice.sprint.to_s %>" class="label label-warning">
          Payment Requested
        </div>
        <div style="display:inline" id="request_payment_button_2_sprint_<%= invoice.sprint.to_s %>">
          <%= link_to '<div class="label label-success">Request Payment</div>'.html_safe,
                      request_payment_path(invoice.id),
                      remote: true %>
        </div>
      <% else %>
        <div style="display:none;margin-right:10px" id="request_payment_cancelled_sprint_<%= invoice.sprint.to_s %>" class="label label-warning">
          Payment Request Cancelled
        </div>
        <div style="display:inline" id="request_payment_cancel_button_sprint_<%= invoice.sprint.to_s %>">
          <%= link_to '<div class="label label-warning">Payment Requested <small>(Cancel)</small></div>'.html_safe,
                      cancel_request_payment_path(invoice.id),
                      remote: true %>
        </div>
      <% end %>

      <div class="label label-success">Payment: $<%= payment_total %></div>
      <div class="label label-info">Cost: $<%= price_total %></div>
      <div class="label label-default">Hours: <%= invoice.sprint_hours %> hrs</div>
      <div class="label label-default">Projected: <%= invoice.sprint_planned_hours %> hrs</div>

    </div>
  </div>
  <div class="panel-body">
    <h5><strong>Summary: </strong><%= invoice.description %></h5>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>Task</th>
        <th>Rate</th>
        <th>Hours</th>
        <th>Cost</th>
      </tr>
      </thead>

      <tbody
      <% if invoice.project.current_task == invoice.id %>
      class="current_sprint task_list">
      <% else %>
      >
      <% end %>

      <% invoice.invoice_items.each do |task| %>
      <tr onclick="$('#task_<%= task.id.to_s %>').toggle('slide'); return false;">
          <!--onmouseout="document.getElementById('task_<%#= task.id.to_s %>').style.display = 'none';">-->
        <td>
          <% if invoice.project.current_task == task %>
            <span class="label label-default">Current Task</span>
            <span id="task_<%= task.id.to_s %>" style="display:none;font-size:.8em; padding-right:20px;">
              <%#= '<span id="task_' + task.id.to_s + '" style="display:none;font-size:.8em; padding-right:20px;">'.html_safe %>
              <%= link_to '<i style="padding-right: 4px;" class="fas fa-trash-alt"></i>'.html_safe,
                          delete_task_inline_path(task.id), data: {confirm: "Are you sure?"}, remote: true,
                          class: 'btn btn-sm btn-default', style: 'padding:10px;color:white;background-color:#777;font-size:1.2em; padding:2px; display:inline;' %>

          </span>
          <% else %>
              <span id="task_<%= task.id.to_s %>" style="display:none;font-size:.8em; padding-right:20px;">
                <%= link_to 'Set Current Tasks',
                            set_current_task_path(invoice.project.id, task.id), remote: true,
                            class: 'btn btn-sm btn-success', style: 'display:inline;font-size:1em; padding:5px; padding-right:10px;' %>
                <%= link_to '<i style="padding-right: 4px;" class="fas fa-trash-alt"></i>'.html_safe,
                            delete_task_inline_path(task.id), data: {confirm: "Are you sure?"}, remote: true,
                            class: 'btn btn-sm btn-default', style: 'padding:10x;color:white;background-color:#777;font-size:1.2em; padding:2px; display:inline;' %>

            </span>
          <% end %>

          <%= task.description %>
        </td>
        <td>$<%= task.rate %>/hr</td>
        <td><%= task.hours %></td>
        <td>$<%= task.rate * task.hours %></td>
      </tr>
      <% end %>

      <tr style="display:none" id="invoice_items_<%= invoice.id.to_s %>_hidden_row"></tr>
      <tr>
        <th id="create_task_container_invoice_<%= invoice.id.to_s %>">
          <%= link_to 'Create Task',
                      create_task_inline_path(invoice.id),
                      remote: true,
                      id: 'create_task_inline_button',
                      class: 'btn btn-sm btn-primary',
                      style: 'display:inline;font-size:1em; padding-right:10px;' %>
        </th>
        <th><strong>Total:</strong></th>
        <th><%= hour_total %> hrs.</th>
        <th>$<%= price_total %></th>
      </tr>
      </tbody>
    </table>

    <table class="table table-condensed">
      <tbody>
      <% invoice.payments.each do |payment| %>
        <tr>
          <td><%= payment.amount %></td>
          <td><%= payment.payment_type %></td>
          <td><%= payment.user.first_name %> <%= payment.user.last_name %></td>
          <td><%= payment.created_at.strftime("%d %b. %Y") %> </td>
        </tr>
      <% end %>
      <tr>
        <td></td>
        <td></td>
        <td><strong>Payment Total:</strong></td>
        <td><%= payment_total %></td>
      </tr>
      </tbody>
    </table>
    <% if invoice.sprint_cost > invoice.sprint_payments %>
      <div class="label label-danger">Balance: $<%= invoice.sprint_cost - invoice.sprint_payments %></div>
    <% end %>
  </div>
</div>